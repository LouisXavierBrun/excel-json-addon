<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>JSON Export/Import</title>
    
    <!-- Polyfills pour IE11 -->
    <script>
        // Polyfill pour Object.keys
        if (!Object.keys) {
            Object.keys = function(obj) {
                var keys = [];
                for (var key in obj) {
                    if (obj.hasOwnProperty(key)) {
                        keys.push(key);
                    }
                }
                return keys;
            };
        }
        
        // Polyfill pour Array.forEach
        if (!Array.prototype.forEach) {
            Array.prototype.forEach = function(callback, thisArg) {
                for (var i = 0; i < this.length; i++) {
                    callback.call(thisArg, this[i], i, this);
                }
            };
        }
        
        // Polyfill pour Array.filter
        if (!Array.prototype.filter) {
            Array.prototype.filter = function(callback, thisArg) {
                var result = [];
                for (var i = 0; i < this.length; i++) {
                    if (callback.call(thisArg, this[i], i, this)) {
                        result.push(this[i]);
                    }
                }
                return result;
            };
        }
        
        // Polyfill pour Array.map
        if (!Array.prototype.map) {
            Array.prototype.map = function(callback, thisArg) {
                var result = [];
                for (var i = 0; i < this.length; i++) {
                    result.push(callback.call(thisArg, this[i], i, this));
                }
                return result;
            };
        }
        
        // Polyfill pour Array.some
        if (!Array.prototype.some) {
            Array.prototype.some = function(callback, thisArg) {
                for (var i = 0; i < this.length; i++) {
                    if (callback.call(thisArg, this[i], i, this)) {
                        return true;
                    }
                }
                return false;
            };
        }
        
        // Polyfill pour String.fromCharCode am√©lior√©
        if (!String.fromCharCode.apply) {
            // Fallback pour les tr√®s vieux navigateurs
        }
        
        // D√©tection du navigateur
        function isIE11() {
            return navigator.userAgent.indexOf("Trident") !== -1;
        }
        
        function isEdgeLegacy() {
            return navigator.userAgent.indexOf("EdgeHTML") !== -1;
        }
    </script>
    
    <!-- Office JavaScript API -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    
    <!-- Fabric UI CSS -->
    <link rel="stylesheet" href="https://static2.sharepointonline.com/files/fabric/office-ui-fabric-core/11.0.0/css/fabric.min.css">
    
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f3f2f1;
            /* Support IE11 */
            -ms-overflow-style: scrollbar;
        }
        
        .container {
            max-width: 100%;
        }
        
        .section {
            background: white;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 20px;
            /* Shadow compatible IE */
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #323130;
        }
        
        .button {
            background-color: #0078d4;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 2px;
            width: 100%;
            /* Transition compatible IE */
            -ms-transition: background-color 0.3s;
            -webkit-transition: background-color 0.3s;
            transition: background-color 0.3s;
        }
        
        .button:hover {
            background-color: #106ebe;
        }
        
        .button:disabled {
            background-color: #a19f9d;
            cursor: not-allowed;
        }
        
        .textarea {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 1px solid #d2d0ce;
            border-radius: 2px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
            box-sizing: border-box;
        }
        
        .file-input {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            border: 1px solid #d2d0ce;
            border-radius: 2px;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 2px;
            display: none;
        }
        
        .status.success {
            background-color: #dff6dd;
            border: 1px solid #0e700e;
            color: #0e700e;
        }
        
        .status.error {
            background-color: #fed9cc;
            border: 1px solid #d13438;
            color: #d13438;
        }
        
        .description {
            font-size: 12px;
            color: #605e5c;
            margin-bottom: 10px;
        }
        
        /* Styles pour le modal compatible IE */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            /* Transform compatible IE9+ */
            -ms-transform: translate(-50%, -50%);
            -webkit-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 8px;
            padding: 20px;
            max-width: 600px;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: block; /* Fallback pour IE */
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #323130;
            display: inline-block;
        }
        
        .close-button {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #605e5c;
            float: right;
        }
        
        .change-stats {
            background: #f3f2f1;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .change-details {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #d2d0ce;
            border-radius: 4px;
            padding: 10px;
        }
        
        .button-group {
            margin-top: 20px;
            text-align: right;
        }
        
        .button-group .button {
            width: auto;
            margin-left: 10px;
        }
        
        .change-item {
            padding: 5px;
            margin: 5px 0;
        }
        
        .change-new {
            border-left: 3px solid #107c10;
            background: #f6ffed;
        }
        
        .change-deleted {
            border-left: 3px solid #d13438;
            background: #fff2f0;
        }
        
        .change-modified {
            border-left: 3px solid #ff8c00;
            background: #fff7e6;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="section">
            <div class="section-title">üì§ Exporter vers JSON</div>
            <div class="description">Exporte la premi√®re feuille du classeur au format JSON</div>
            <button class="button" id="exportBtn">Convertir le tableau</button>
            <textarea class="textarea" id="exportResult" placeholder="Le JSON √† exporter appara√Ætra ici..." readonly></textarea>
            <button class="button" id="downloadBtn" style="display: none;">T√©l√©charger le fichier JSON</button>
        </div>

        <div class="section">
            <div class="section-title">üì• Importer depuis JSON</div>
            <div class="description">Importe des donn√©es JSON dans la feuille active (cr√©e une r√©vision si la feuille n'est pas vide)</div>
            
            <input type="file" class="file-input" id="fileInput" accept=".json" />
            <textarea class="textarea" id="importData" placeholder="Ou collez votre JSON ici..."></textarea>
            <button class="button" id="importBtn">Analyser les changements</button>
        </div>

        <!-- Modal d'aper√ßu des changements -->
        <div id="changeModal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Aper√ßu des changements</h3>
                    <button id="closeModal" class="close-button">√ó</button>
                    <div style="clear: both;"></div>
                </div>
                
                <div id="changeStats" class="change-stats">
                    <!-- Statistiques des changements -->
                </div>
                
                <div id="changeDetails" class="change-details">
                    <!-- D√©tails des changements -->
                </div>
                
                <div class="button-group">
                    <button id="cancelImport" class="button" style="background-color: #a19f9d;">Annuler</button>
                    <button id="confirmImport" class="button">Importer et remplacer</button>
                </div>
            </div>
        </div>

        <div class="status" id="statusMessage"></div>
    </div>

    <script>
        // Variables globales
        var exportedData = null;
        var pendingImportData = null;
        var currentWorksheetData = null;
        var currentWorkbookName = null;

        function showStatus(message, isError = false) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = 'status ' + (isError ? 'error' : 'success');
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }

        async function loadWorksheets() {
            // Cette fonction n'est plus n√©cessaire car nous utilisons la feuille active
        }

        async function analyzeChanges() {
            try {
                const jsonText = document.getElementById('importData').value.trim();
                
                if (!jsonText) {
                    throw new Error('Veuillez fournir des donn√©es JSON');
                }
                
                let jsonData;
                try {
                    jsonData = JSON.parse(jsonText);
                } catch (e) {
                    throw new Error('JSON invalide: ' + e.message);
                }
                
                if (!Array.isArray(jsonData) || jsonData.length === 0) {
                    throw new Error('Le JSON doit √™tre un tableau non vide d\'objets');
                }
                
                document.getElementById('importBtn').disabled = true;
                
                await Excel.run(async (context) => {
                    // Obtenir la feuille active
                    const activeWorksheet = context.workbook.worksheets.getActiveWorksheet();
                    activeWorksheet.load("name");
                    
                    // Obtenir les donn√©es actuelles
                    const usedRange = activeWorksheet.getUsedRange(true);
                    let currentData = [];
                    
                    if (usedRange) {
                        usedRange.load("values");
                        await context.sync();
                        currentData = usedRange.values;
                    } else {
                        await context.sync();
                    }
                    
                    // Stocker les donn√©es pour l'import
                    pendingImportData = jsonData;
                    currentWorksheetData = currentData;
                    
                    // Analyser les changements
                    const changes = compareData(currentData, jsonData);
                    
                    // Afficher le modal avec les changements
                    showChangeModal(changes, activeWorksheet.name);
                });
                
            } catch (error) {
                showStatus('Erreur lors de l\'analyse: ' + error.message, true);
            } finally {
                document.getElementById('importBtn').disabled = false;
            }
        }

        function compareData(currentData, newJsonData) {
            const changes = {
                newCells: 0,
                deletedCells: 0,
                modifiedCells: 0,
                details: []
            };
            
            // Pr√©parer les nouvelles donn√©es pour la comparaison
            const headers = newJsonData.length > 0 ? Object.keys(newJsonData[0]) : [];
            const newDataFormatted = [headers];
            
            newJsonData.forEach(item => {
                const row = headers.map(header => item[header] || '');
                newDataFormatted.push(row);
            });
            
            // Comparer les dimensions
            const currentRows = currentData.length;
            const currentCols = currentData.length > 0 ? currentData[0].length : 0;
            const newRows = newDataFormatted.length;
            const newCols = headers.length;
            
            // Analyser les changements cellule par cellule
            const maxRows = Math.max(currentRows, newRows);
            const maxCols = Math.max(currentCols, newCols);
            
            for (let row = 0; row < maxRows; row++) {
                for (let col = 0; col < maxCols; col++) {
                    const currentValue = (currentData[row] && currentData[row][col] !== undefined) ? currentData[row][col] : '';
                    const newValue = (newDataFormatted[row] && newDataFormatted[row][col] !== undefined) ? newDataFormatted[row][col] : '';
                    
                    // Normaliser les valeurs pour la comparaison (traiter null comme cha√Æne vide)
                    const currentNormalized = (currentValue === null || currentValue === undefined) ? '' : String(currentValue);
                    const newNormalized = (newValue === null || newValue === undefined) ? '' : String(newValue);
                    
                    const currentEmpty = currentNormalized === '';
                    const newEmpty = newNormalized === '';
                    
                    if (currentEmpty && !newEmpty) {
                        changes.newCells++;
                        changes.details.push({
                            type: 'new',
                            cell: `${String.fromCharCode(65 + col)}${row + 1}`,
                            value: newNormalized
                        });
                    } else if (!currentEmpty && newEmpty) {
                        changes.deletedCells++;
                        changes.details.push({
                            type: 'deleted',
                            cell: `${String.fromCharCode(65 + col)}${row + 1}`,
                            oldValue: currentNormalized
                        });
                    } else if (!currentEmpty && !newEmpty && currentNormalized !== newNormalized) {
                        changes.modifiedCells++;
                        changes.details.push({
                            type: 'modified',
                            cell: `${String.fromCharCode(65 + col)}${row + 1}`,
                            oldValue: currentNormalized,
                            newValue: newNormalized
                        });
                    }
                }
            }
            
            return changes;
        }

        function showChangeModal(changes, worksheetName) {
            const modal = document.getElementById('changeModal');
            const statsDiv = document.getElementById('changeStats');
            const detailsDiv = document.getElementById('changeDetails');
            
            // Afficher les statistiques
            statsDiv.innerHTML = `
                <h4 style="margin: 0 0 10px 0;">Feuille: ${worksheetName}</h4>
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div style="color: #107c10;"><strong>${changes.newCells}</strong> nouvelles cellules</div>
                    <div style="color: #d13438;"><strong>${changes.deletedCells}</strong> cellules supprim√©es</div>
                    <div style="color: #ff8c00;"><strong>${changes.modifiedCells}</strong> cellules modifi√©es</div>
                </div>
            `;
            
            // Afficher les d√©tails (limit√© aux 50 premiers changements)
            const limitedDetails = changes.details.slice(0, 50);
            detailsDiv.innerHTML = limitedDetails.map(change => {
                switch (change.type) {
                    case 'new':
                        return `<div style="padding: 5px; border-left: 3px solid #107c10; margin: 5px 0; background: #f6ffed;">
                            <strong>${change.cell}</strong>: Nouvelle valeur "<em>${change.value}</em>"
                        </div>`;
                    case 'deleted':
                        return `<div style="padding: 5px; border-left: 3px solid #d13438; margin: 5px 0; background: #fff2f0;">
                            <strong>${change.cell}</strong>: Valeur supprim√©e "<em>${change.oldValue}</em>"
                        </div>`;
                    case 'modified':
                        return `<div style="padding: 5px; border-left: 3px solid #ff8c00; margin: 5px 0; background: #fff7e6;">
                            <strong>${change.cell}</strong>: "<em>${change.oldValue}</em>" ‚Üí "<em>${change.newValue}</em>"
                        </div>`;
                    default:
                        return '';
                }
            }).join('');
            
            if (changes.details.length > 50) {
                detailsDiv.innerHTML += `<div style="text-align: center; padding: 10px; color: #605e5c; font-style: italic;">
                    ... et ${changes.details.length - 50} autres changements
                </div>`;
            }
            
            if (changes.details.length === 0) {
                detailsDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #605e5c;">Aucun changement d√©tect√©</div>';
            }
            
            modal.style.display = 'block';
        }

        function closeChangeModal() {
            document.getElementById('changeModal').style.display = 'none';
            pendingImportData = null;
            currentWorksheetData = null;
        }

        async function confirmImport() {
            if (!pendingImportData) {
                showStatus('Aucune donn√©e √† importer', true);
                return;
            }
            
            try {
                await Excel.run(async (context) => {
                    const activeWorksheet = context.workbook.worksheets.getActiveWorksheet();
                    
                    // V√©rifier si la feuille n'est pas vide pour cr√©er une r√©vision
                    const usedRange = activeWorksheet.getUsedRange(true);
                    if (usedRange) {
                        // La feuille n'est pas vide, effacer le contenu existant
                        usedRange.clear();
                    }
                    
                    // Pr√©parer les donn√©es pour l'insertion
                    const headers = Object.keys(pendingImportData[0]);
                    const dataToInsert = [headers];
                    
                    pendingImportData.forEach(item => {
                        const row = headers.map(header => {
                            const value = item[header];
                            // Pr√©server les valeurs exactes, y compris les cha√Ænes vides
                            return value !== undefined ? value : '';
                        });
                        dataToInsert.push(row);
                    });
                    
                    // Ins√©rer les donn√©es
                    const range = activeWorksheet.getRange(`A1:${String.fromCharCode(64 + headers.length)}${dataToInsert.length}`);
                    range.values = dataToInsert;
                    
                    // Formater les en-t√™tes
                    const headerRange = activeWorksheet.getRange(`A1:${String.fromCharCode(64 + headers.length)}1`);
                    headerRange.format.font.bold = true;
                    headerRange.format.fill.color = "#4472C4";
                    headerRange.format.font.color = "white";
                    
                    // Auto-ajuster les colonnes
                    range.format.autofitColumns();
                    
                    await context.sync();
                    
                    closeChangeModal();
                    showStatus(`Import r√©ussi! ${pendingImportData.length} lignes import√©es dans la feuille active.`);
                });
                
            } catch (error) {
                showStatus('Erreur lors de l\'import: ' + error.message, true);
            }
        }

        async function exportToJSON() {
            try {
                document.getElementById('exportBtn').disabled = true;
                
                await Excel.run(async (context) => {
                    // Obtenir le nom du classeur
                    const workbook = context.workbook;
                    workbook.load("name");
                    
                    // Obtenir la premi√®re feuille
                    const worksheets = workbook.worksheets;
                    worksheets.load("items");
                    await context.sync();
                    
                    // Stocker le nom du classeur
                    currentWorkbookName = workbook.name;
                    
                    if (worksheets.items.length === 0) {
                        throw new Error('Aucune feuille trouv√©e dans le classeur');
                    }
                    
                    const firstWorksheet = worksheets.items[0];
                    const range = firstWorksheet.getUsedRange();
                    range.load("values");
                    
                    await context.sync();
                    
                    if (!range.values || range.values.length === 0) {
                        throw new Error('La premi√®re feuille est vide');
                    }
                    
                    // Convertir les donn√©es en JSON en excluant les cellules vides
                    const data = range.values;
                    const headers = data[0];
                    const rows = data.slice(1);
                    
                    const jsonData = rows
                        .filter(row => row.some(cell => cell !== null && cell !== undefined && cell !== '')) // Exclure les lignes compl√®tement vides
                        .map(row => {
                            const obj = {};
                            headers.forEach((header, index) => {
                                const cellValue = row[index];
                                // N'ajouter que les cellules non vides
                                if (cellValue !== null && cellValue !== undefined && cellValue !== '') {
                                    obj[header] = cellValue;
                                }
                            });
                            // Ne retourner l'objet que s'il a au moins une propri√©t√©
                            return Object.keys(obj).length > 0 ? obj : null;
                        })
                        .filter(obj => obj !== null); // Supprimer les objets vides
                    
                    exportedData = jsonData;
                    document.getElementById('exportResult').value = JSON.stringify(jsonData, null, 2);
                    document.getElementById('downloadBtn').style.display = 'inline-block';
                    
                    showStatus('Export r√©ussi! ' + jsonData.length + ' lignes export√©es (cellules vides exclues).');
                });
            } catch (error) {
                showStatus('Erreur lors de l\'export: ' + error.message, true);
            } finally {
                document.getElementById('exportBtn').disabled = false;
            }
        }

        function downloadJSON() {
            if (!exportedData) return;
            
            const dataStr = JSON.stringify(exportedData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            // Utiliser le nom du classeur Excel ou un nom par d√©faut
            let fileName = 'excel_export.json';
            if (currentWorkbookName) {
                // Nettoyer le nom du fichier (supprimer l'extension .xlsx si pr√©sente)
                let cleanName = currentWorkbookName.replace(/\.(xlsx|xls|xlsm|xlsb)$/i, '');
                // Remplacer les caract√®res non autoris√©s par des underscores
                cleanName = cleanName.replace(/[<>:"/\\|?*]/g, '_');
                fileName = cleanName + '.json';
            }
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', fileName);
            linkElement.click();
            
            showStatus(`Fichier "${fileName}" t√©l√©charg√© avec succ√®s!`);
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.type === "application/json") {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('importData').value = e.target.result;
                };
                reader.readAsText(file);
            }
            
            // R√©initialiser l'input file pour permettre de s√©lectionner le m√™me fichier
            event.target.value = '';
        }

        async function importFromJSON() {
            // Cette fonction est remplac√©e par analyzeChanges et confirmImport
        }
    </script>
</body>
</html>
